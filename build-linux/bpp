#!/usr/bin/env bash
set -euo pipefail

BPP_BINDIR_REL="bin"
BPP_LIBEXECDIR_REL="libexec"
BPP_DATADIR_REL="share"
BPP_VERSION="v10"

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
prefix_dir="$script_dir"
IFS='/' read -r -a bindir_parts <<< "$BPP_BINDIR_REL"
for part in "${bindir_parts[@]}"; do
    if [ -n "$part" ] && [ "$part" != "." ]; then
        prefix_dir="$(dirname "$prefix_dir")"
    fi
done

if [ -n "${BPP_PREFIX:-}" ]; then
    prefix_dir="$BPP_PREFIX"
fi

resolve_install_path() {
    local rel="$1"
    if [[ "$rel" = /* ]]; then
        echo "$rel"
    else
        echo "$prefix_dir/$rel"
    fi
}

BPP_COMPILER="$(resolve_install_path "$BPP_LIBEXECDIR_REL/bpp/${BPP_VERSION}_stage1")"
BPP_STD_DIR="$(resolve_install_path "$BPP_DATADIR_REL/bpp/$BPP_VERSION/src/std")"

print_usage() {
    echo "Usage: bpp [-O0|-O1] [-dump-ir|-dump-ssa|-asm] <source.bpp>"
}

if [ "$#" -lt 1 ]; then
    print_usage
    exit 1
fi

if [ ! -x "$BPP_COMPILER" ]; then
    echo "[ERROR] Installed compiler not found or not executable: $BPP_COMPILER" >&2
    exit 1
fi

if [ ! -d "$BPP_STD_DIR" ]; then
    echo "[ERROR] Installed std directory not found: $BPP_STD_DIR" >&2
    exit 1
fi

if [ ! -x "/usr/bin/nasm" ]; then
    echo "[ERROR] /usr/bin/nasm is required by the current compiler runtime." >&2
    exit 1
fi

if [ ! -x "/usr/bin/ld" ]; then
    echo "[ERROR] /usr/bin/ld is required by the current compiler runtime." >&2
    exit 1
fi

args=("$@")
source_index=-1
for i in "${!args[@]}"; do
    if [[ "${args[$i]}" != -* ]]; then
        source_index="$i"
    fi
done

if [ "$source_index" -lt 0 ]; then
    print_usage
    exit 1
fi

source_path="${args[$source_index]}"
if [ ! -f "$source_path" ]; then
    echo "[ERROR] Source file not found: $source_path" >&2
    exit 1
fi

source_abs="$(cd "$(dirname "$source_path")" && pwd)/$(basename "$source_path")"
source_dir="$(dirname "$source_abs")"
source_name="$(basename "$source_abs")"

tmp_root="$(mktemp -d "/tmp/bpp_run_XXXXXX")"
cleanup() {
    rm -rf "$tmp_root"
}
trap cleanup EXIT

mkdir -p "$tmp_root/src"
ln -s "$source_dir" "$tmp_root/src/user"
ln -s "$BPP_STD_DIR" "$tmp_root/src/std"

nasm_path="$(command -v nasm 2>/dev/null || true)"
ld_path="$(command -v ld 2>/dev/null || true)"
cat > "$tmp_root/bpp.toml" <<EOF
version=$BPP_VERSION
module_root=src/user
std_root=src
EOF
if [ -n "$nasm_path" ]; then
    printf 'nasm_path=%s\n' "$nasm_path" >> "$tmp_root/bpp.toml"
fi
if [ -n "$ld_path" ]; then
    printf 'ld_path=%s\n' "$ld_path" >> "$tmp_root/bpp.toml"
fi

cat > "$tmp_root/config.ini" <<EOF
VERSION=$BPP_VERSION
PREV_VERSION=$BPP_VERSION
EOF

args[$source_index]="$tmp_root/src/user/$source_name"
exec "$BPP_COMPILER" "${args[@]}"
