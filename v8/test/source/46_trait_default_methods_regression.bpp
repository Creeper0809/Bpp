// Covers: trait default methods, default method chaining, and per-impl override interaction
// Expect exit code: 0

trait CounterOps {
    func value(self: *Self) -> i64;

    func twice(self: *Self) -> i64 {
        return self.value() * 2;
    }

    func mix(self: *Self, a: i64, b: i64) -> i64 {
        return self.twice() + a - b;
    }
}

struct BaseCounter {
    n: i64;
}

struct FancyCounter {
    n: i64;
}

impl CounterOps for BaseCounter {
    func value(self: *BaseCounter) -> i64 {
        return self.n;
    }
}

impl CounterOps for FancyCounter {
    func value(self: *FancyCounter) -> i64 {
        return self.n + 1;
    }

    func twice(self: *FancyCounter) -> i64 {
        return self.value() * 3;
    }
}

func main() -> i64 {
    var b: BaseCounter;
    b.n = 7;

    var f: FancyCounter;
    f.n = 4;

    var tb: *CounterOps = (*CounterOps)&b;
    var tf: *CounterOps = (*CounterOps)&f;

    if (tb.value() != 7) { return 1; }
    if (tb.twice() != 14) { return 2; }
    if (tb.mix(10, 3) != 21) { return 3; }

    if (tf.value() != 5) { return 4; }
    if (tf.twice() != 15) { return 5; }
    if (tf.mix(2, 1) != 16) { return 6; } // default mix should call overridden twice()

    return 0;
}
