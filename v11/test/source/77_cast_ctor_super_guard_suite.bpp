// Covers: downcast/constructor/super guard suite

//=== CASE 77_checked_downcast_runtime_fail
// Covers: checked downcast trap when casting parent pointer to wrong derived type
// Expect exit code: 132

struct ShapeCast {
    public bias: i64;
}

struct RectCast : ShapeCast {
    public w: i64;
    public h: i64;
}

struct CircleCast : ShapeCast {
    public r: i64;
}

impl ShapeCast {
    public abst func area(self: *ShapeCast) -> i64;
}

impl RectCast {
    @[override]
    public func area(self: *RectCast) -> i64 {
        return self.w * self.h + self.bias;
    }
}

impl CircleCast {
    @[override]
    public func area(self: *CircleCast) -> i64 {
        return self.r * self.r + self.bias;
    }
}

func main() -> i64 {
    var r: RectCast;
    r.bias = 1;
    r.w = 3;
    r.h = 4;

    var up: *ShapeCast = (*ShapeCast)&r;
    var wrong: *CircleCast = (*CircleCast)up;
    return wrong.area();
}
//=== END

//=== CASE 78_unchecked_downcast_without_rtti_fail
// Covers: compile-fail for strict downcast without trait/vtable metadata
// Expect compile fail: 1
// Expect error contains: unchecked downcast is forbidden without virtual dispatch metadata

struct BaseNoRtti {
    public a: i64;
}

struct LeftNoRtti : BaseNoRtti {
    public l: i64;
}

struct RightNoRtti : BaseNoRtti {
    public r: i64;
}

func main() -> i64 {
    var b: BaseNoRtti;
    b.a = 1;
    var p: *BaseNoRtti = (*BaseNoRtti)&b;
    var bad: *RightNoRtti = (*RightNoRtti)p;
    return bad.r;
}
//=== END

//=== CASE 79_private_constructor_new_fail
// Covers: compile-fail for private constructor called via new
// Expect compile fail: 1
// Expect error contains: constructor access denied

struct SecretNew {
    public value: i64;
}

impl SecretNew {
    private constructor(v: i64) {
        self.value = v;
    }
}

func main() -> i64 {
    var s: *SecretNew = new SecretNew(7);
    if (s == 0) { return 1; }
    return s.value;
}
//=== END

//=== CASE 80_private_constructor_stack_ctor_fail
// Covers: compile-fail for private constructor called via stack constructor sugar
// Expect compile fail: 1
// Expect error contains: constructor access denied

struct SecretStack {
    public value: i64;
}

impl SecretStack {
    private constructor(v: i64) {
        self.value = v;
    }
}

func main() -> i64 {
    var s: SecretStack = SecretStack(11);
    return s.value;
}
//=== END

//=== CASE 81_super_static_method_fail
// Covers: compile-fail for super usage inside static impl method
// Expect compile fail: 1
// Expect error contains: 'super' is not allowed in static methods

struct ParentStatic {
    public v: i64;
}

struct ChildStatic : ParentStatic {
    public w: i64;
}

impl ParentStatic {
    public func value(self: *ParentStatic) -> i64 {
        return self.v;
    }
}

impl ChildStatic {
    public static func bad() -> i64 {
        return super.value();
    }
}

func main() -> i64 {
    return ChildStatic.bad();
}
//=== END
