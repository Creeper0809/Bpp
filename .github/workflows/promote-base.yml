name: Promote Base Binary

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  promote-base:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm binutils coreutils

      - name: Build and verify compiler
        run: |
          chmod +x build_and_test.sh test/run_tests.sh
          TEST_QUIET=1 bash build_and_test.sh

      - name: Promote latest stage1 as base
        shell: bash
        run: |
          set -euo pipefail

          best=-1
          latest_tag=""
          for f in bin/v*_stage1; do
            [ -f "$f" ] || continue
            base="$(basename "$f")"
            if [[ "$base" =~ ^v([0-9]+)_stage1$ ]]; then
              n="${BASH_REMATCH[1]}"
              if [ "$n" -ge "$best" ]; then
                best="$n"
                latest_tag="v${n}"
              fi
            fi
          done

          if [ -z "$latest_tag" ]; then
            echo "Error: no versioned stage1 binary found in bin/"
            exit 1
          fi

          src="bin/${latest_tag}_stage1"
          dst_old="old/${latest_tag}/bin/${latest_tag}_stage1"

          mkdir -p "old/${latest_tag}/bin"
          cp -f "$src" "$dst_old"
          cp -f "$src" "bin/stage1"
          cp -f "$src" "bin/bootstrap"
          chmod +x "$src" "$dst_old" "bin/stage1" "bin/bootstrap" || true

          echo "LATEST_TAG=${latest_tag}" >> "$GITHUB_ENV"
          echo "Promoted base binary: ${latest_tag}"

      - name: Commit and push promoted base binary
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -f \
            "bin/${LATEST_TAG}_stage1" \
            "bin/stage1" \
            "bin/bootstrap" \
            "old/${LATEST_TAG}/bin/${LATEST_TAG}_stage1"

          if git diff --cached --quiet; then
            echo "No base binary changes to commit."
            exit 0
          fi

          git commit -m "chore(base): promote ${LATEST_TAG} stage1 [skip ci]"
          git push
