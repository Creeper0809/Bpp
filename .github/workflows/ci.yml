name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  linux-v10:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm binutils coreutils

      - name: Build and test (Linux)
        run: |
          chmod +x v10/build_and_test.sh v10/test/run_tests.sh
          cd v10
          bash build_and_test.sh

  windows-v10:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC developer command prompt
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure toolchain with CMake
        run: |
          cmake -S . -B build-win -DBPP_BOOTSTRAP_NASM=ON -DBPP_ACTIVE_VERSION=v10

      - name: Export resolved toolchain paths
        shell: pwsh
        run: |
          Get-Content build-win/bpp_toolchain.env | ForEach-Object {
            if ($_ -match '^(.*?)=(.*)$') {
              "$($matches[1])=$($matches[2])" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            }
          }

      - name: Toolchain check + Windows executable smoke test
        run: |
          cmake --build build-win --target toolchain-check windows-smoke

      - name: Toolchain-only sanity via PowerShell runner
        shell: pwsh
        run: |
          ./v10/build_and_test.ps1 -ToolchainOnly -NasmPath "$env:BPP_NASM_EXECUTABLE" -LinkerPath "$env:BPP_LINKER_EXECUTABLE"

      - name: Optional full Windows compiler test (requires stage compiler exe)
        shell: pwsh
        run: |
          $compilerExe = Resolve-Path "./bin/v10_stage1.exe" -ErrorAction SilentlyContinue
          if ($compilerExe) {
            ./v10/build_and_test.ps1 -CompilerPath $compilerExe.Path -NasmPath "$env:BPP_NASM_EXECUTABLE" -LinkerPath "$env:BPP_LINKER_EXECUTABLE"
          } else {
            Write-Warning "Skipping full Windows compiler tests: bin/v10_stage1.exe is not present in repository."
          }
