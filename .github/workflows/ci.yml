name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm binutils coreutils

      - name: Build and test (Linux)
        run: |
          chmod +x build_and_test.sh test/run_tests.sh
          bash build_and_test.sh

      - name: Diagnostics + manifest regression (Linux)
        run: |
          chmod +x test/run_regression.sh
          VERSION="$(grep -E '^VERSION=' config.ini | head -n1 | cut -d'=' -f2 | tr -d '[:space:]')"
          bash test/run_regression.sh "bin/${VERSION}_stage1"

      - name: CMake install + bpp CLI smoke (Linux)
        run: |
          cmake -S . -B build-linux
          cmake --build build-linux --target toolchain-check
          cmake --install build-linux --prefix "$PWD/.local"
          ./.local/bin/bpp test/source/05_pointers_arrays.bpp

  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC developer command prompt
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure toolchain with CMake
        run: |
          cmake -S . -B build-win -DBPP_BOOTSTRAP_NASM=ON

      - name: Export resolved toolchain paths
        shell: pwsh
        run: |
          Get-Content build-win/bpp_toolchain.env | ForEach-Object {
            if ($_ -match '^(.*?)=(.*)$') {
              "$($matches[1])=$($matches[2])" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            }
          }

      - name: Toolchain check + Windows executable smoke test
        run: |
          cmake --build build-win --target toolchain-check windows-smoke

      - name: Toolchain-only sanity via PowerShell runner
        shell: pwsh
        run: |
          ./build_and_test.ps1 -ToolchainOnly -NasmPath "$env:BPP_NASM_EXECUTABLE" -LinkerPath "$env:BPP_LINKER_EXECUTABLE"

      - name: Optional full Windows compiler test (requires stage compiler exe)
        shell: pwsh
        run: |
          $versionLine = Get-Content "./config.ini" | Where-Object { $_ -match '^VERSION=' } | Select-Object -First 1
          $version = if ($versionLine) { ($versionLine -split '=', 2)[1].Trim() } else { "v11" }
          $compilerExe = Resolve-Path "./bin/${version}_stage1.exe" -ErrorAction SilentlyContinue
          if ($compilerExe) {
            ./build_and_test.ps1 -CompilerPath $compilerExe.Path -NasmPath "$env:BPP_NASM_EXECUTABLE" -LinkerPath "$env:BPP_LINKER_EXECUTABLE"
          } else {
            Write-Warning "Skipping full Windows compiler tests: bin/${version}_stage1.exe is not present in repository."
          }
