// Covers: abstract-based virtual dispatch across inheritance and dynamic call from parent method body
// Expect exit code: 0

struct Parent {
    v: i64;
}

struct Child : Parent {
    x: i64;
}

struct Grand : Child {
    y: i64;
}

impl Parent {
    public abst func calc(self: *Parent) -> i64;

    public func calc_plus(self: *Parent, k: i64) -> i64 {
        return self.calc() + k;
    }
}

impl Child {
    public func calc(self: *Child) -> i64 {
        return self.v + self.x;
    }
}

impl Grand {
    public func calc(self: *Grand) -> i64 {
        return self.v + self.x + self.y;
    }
}

func main() -> i64 {
    var c: Child;
    c.v = 2;
    c.x = 5;

    var g: Grand;
    g.v = 3;
    g.x = 7;
    g.y = 11;

    var p1: *Parent = (*Parent)&c;
    var p2: *Parent = (*Parent)&g;

    if (p1.calc() != 7) { return 1; }
    if (p2.calc() != 21) { return 2; }

    // calc_plus is declared on Parent and internally calls self.calc();
    // this must dispatch virtually to the concrete override.
    if (p1.calc_plus(10) != 17) { return 3; }
    if (p2.calc_plus(10) != 31) { return 4; }

    return 0;
}
