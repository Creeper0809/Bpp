// Covers: trait definitions, impl Trait for Type, vtable dispatch via trait pointers
// Expect exit code: 0

trait Calc {
    func add(self: *Self, v: i64) -> i64;
    func mul(self: *Self, v: i64) -> i64;
}

struct A {
    base: i64;
}

struct B {
    base: i64;
}

impl Calc for A {
    func add(self: *A, v: i64) -> i64 {
        return self.base + v;
    }

    func mul(self: *A, v: i64) -> i64 {
        return self.base * v;
    }
}

impl Calc for B {
    func add(self: *B, v: i64) -> i64 {
        return self.base + v + 10;
    }

    func mul(self: *B, v: i64) -> i64 {
        return self.base * v + 5;
    }
}

func main() -> u64 {
    // Import

    // Setup
    var a: A;
    a.base = 3;
    var b: B;
    b.base = 4;

    // Execution
    var ta: *Calc = (*Calc)&a;
    var tb: *Calc = (*Calc)&b;

    var r1: i64 = ta.add(2);
    var r2: i64 = ta.mul(2);
    var r3: i64 = tb.add(2);
    var r4: i64 = tb.mul(2);

    if (r1 != 5) { return 1; }
    if (r2 != 6) { return 2; }
    if (r3 != 16) { return 3; }
    if (r4 != 13) { return 4; }

    // Assertion
    return 0;
}
