// Covers: pointers, addr/deref, double pointer, arrays, pointer arithmetic, globals (stress)
// Expect exit code: 0

var global_counter: i64;

func main(argc, argv) -> i64 {
    // Import

    // Setup
    var values: [4]i64;
    values[0] = 10;
    values[1] = 20;
    values[2] = 30;
    values[3] = 40;

    var big_values: [64]i64;
    for (var i: i64 = 0; i < 64; i = i + 1) {
        big_values[i] = i * 2;
    }

    // Execution
    var ptr_second: *i64 = &values[1];
    if (*ptr_second != 20) { return 1; }

    var ptr_to_ptr: **i64 = &ptr_second;
    if (**ptr_to_ptr != 20) { return 2; }

    var base_addr: u64 = &values;
    var ptr_third: *i64 = (*i64)(base_addr + 16);
    if (*ptr_third != 30) { return 3; }

    var global_ptr: *i64 = &global_counter;
    *global_ptr = 9;
    if (global_counter != 9) { return 4; }

    // Stress: pointer arithmetic over larger array
    var base_big: u64 = &big_values;
    var sum_big: i64 = 0;
    for (var k: i64 = 0; k < 64; k = k + 1) {
        var elem_ptr: *i64 = (*i64)(base_big + k * 8);
        sum_big = sum_big + *elem_ptr;
    }
    if (sum_big != 4032) { return 5; }

    // Stress: global updates through pointer
    for (var m: i64 = 0; m < 100; m = m + 1) {
        *global_ptr = m;
    }
    if (global_counter != 99) { return 6; }

    // Assertion
    return 0;
}
