// Covers: Vec<T> struct extreme cases (stride/realloc/set/pop)
// Mode: ssa|nossa
// Opt: O0|O1
// Expect exit code: 0

import std.vec;

struct S24 {
    a: u64;
    b: u64;
    c: u64;
}

struct S40 {
    a: u64;
    b: u64;
    c: u64;
    d: u64;
    e: u64;
}

func check_s24(v: *Vec<S24>) -> u64 {
    if (sizeof(S24) != 24) { return 10; }
    if (v->len() != 4) { return 11; }

    var base: u64 = v->data_ptr;
    // index 0
    if (*(*u64)(base + 0) != 100) { return 12; }
    if (*(*u64)(base + 8) != 101) { return 13; }
    if (*(*u64)(base + 16) != 102) { return 14; }
    // index 2 (after set)
    var off2: u64 = 2 * sizeof(S24);
    if (*(*u64)(base + off2 + 0) != 900) { return 15; }
    if (*(*u64)(base + off2 + 8) != 901) { return 16; }
    if (*(*u64)(base + off2 + 16) != 902) { return 17; }
    // index 3 (should remain)
    var off3: u64 = 3 * sizeof(S24);
    if (*(*u64)(base + off3 + 0) != 400) { return 18; }
    if (*(*u64)(base + off3 + 8) != 401) { return 19; }
    if (*(*u64)(base + off3 + 16) != 402) { return 20; }

    return 0;
}

func check_s40(v: *Vec<S40>) -> u64 {
    if (sizeof(S40) != 40) { return 30; }
    if (v->len() != 3) { return 31; }

    var base: u64 = v->data_ptr;
    // index 2
    var off2: u64 = 2 * sizeof(S40);
    if (*(*u64)(base + off2 + 0) != 2020) { return 32; }
    if (*(*u64)(base + off2 + 8) != 2021) { return 33; }
    if (*(*u64)(base + off2 + 16) != 2022) { return 34; }
    if (*(*u64)(base + off2 + 24) != 2023) { return 35; }
    if (*(*u64)(base + off2 + 32) != 2024) { return 36; }

    return 0;
}

func main() -> u64 {
    // Vec<S24>: realloc + set + pop
    var v24: *Vec<S24> = (*Vec<S24>)new Vec<S24>(1);
    for (var i: u64 = 0; i < 5; i = i + 1) {
        var s: S24;
        s.a = 100 + i * 100;
        s.b = 101 + i * 100;
        s.c = 102 + i * 100;
        v24->push(s);
    }
    if (v24->len() != 5) { return 1; }

    var s2: S24;
    s2.a = 900;
    s2.b = 901;
    s2.c = 902;
    v24->set(2, s2);

    v24->pop(); // len: 4

    var r24: u64 = check_s24(v24);
    if (r24 != 0) { return r24; }

    // Vec<S40>: realloc + stride check
    var v40: *Vec<S40> = (*Vec<S40>)new Vec<S40>(2);
    for (var j: u64 = 0; j < 3; j = j + 1) {
        var t: S40;
        t.a = 2000 + j * 10;
        t.b = 2001 + j * 10;
        t.c = 2002 + j * 10;
        t.d = 2003 + j * 10;
        t.e = 2004 + j * 10;
        v40->push(t);
    }

    var r40: u64 = check_s40(v40);
    if (r40 != 0) { return r40; }

    return 0;
}
