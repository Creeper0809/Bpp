// Covers: slice of pointer elements ( []*u8 ) indexing/assignment
// Expect exit code: 0

func main(argc, argv) -> i64 {
    // Import

    // Setup
    var bytes: [4]u8;
    bytes[0] = 65;
    bytes[1] = 66;
    bytes[2] = 67;
    bytes[3] = 68;

    var ptrs: [4]*u8;
    ptrs[0] = &bytes[0];
    ptrs[1] = &bytes[1];
    ptrs[2] = &bytes[2];
    ptrs[3] = &bytes[3];

    var slice_ptrs: []*u8 = slice(&ptrs[0], 4);

    // Execution
    if (*slice_ptrs[0] != 65) { return 1; }
    if (*slice_ptrs[1] != 66) { return 2; }
    if (*slice_ptrs[2] != 67) { return 3; }
    if (*slice_ptrs[3] != 68) { return 4; }

    slice_ptrs[1] = &bytes[3];
    if (*slice_ptrs[1] != 68) { return 5; }

    var sum: i64 = 0;
    for (var i: i64 = 0; i < 4; i = i + 1) {
        sum = sum + *slice_ptrs[i];
    }
    if (sum != 65 + 68 + 67 + 68) { return 6; }

    // Corner: pointer element write-through should update underlying byte array.
    *slice_ptrs[0] = 70;
    if (bytes[0] != 70) { return 7; }

    // Corner: rebind through a sub-slice and verify alias propagation.
    var mid: []*u8 = slice(&slice_ptrs[1], 2);
    if (*mid[0] != 68) { return 8; }
    if (*mid[1] != 67) { return 9; }

    mid[0] = &bytes[2];
    if (*slice_ptrs[1] != 67) { return 10; }

    *mid[1] = 90;
    if (bytes[2] != 90) { return 11; }

    var alias_sum: i64 = 0;
    for (var k: i64 = 0; k < 4; k = k + 1) {
        if ((k & 1) == 0) {
            alias_sum = alias_sum + *slice_ptrs[k];
        } else {
            alias_sum = alias_sum - *slice_ptrs[k];
        }
    }
    if (alias_sum != 2) { return 12; }

    // Corner: re-slice from head and mutate through chained pointer aliases.
    var first_two: []*u8 = slice(&slice_ptrs[0], 2);
    *first_two[1] = *first_two[1] + 5;
    if (bytes[2] != 95) { return 13; }

    first_two[0] = first_two[1];
    if (*slice_ptrs[0] != 95) { return 14; }
    if (*slice_ptrs[2] != 95) { return 15; }

    var final_mix: i64 = 0;
    for (var p: i64 = 0; p < 4; p = p + 1) {
        final_mix = final_mix + *slice_ptrs[p];
    }
    if (final_mix != 353) { return 16; }

    // Assertion
    return 0;
}
