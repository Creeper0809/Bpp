// Covers: new/delete + constructor/destructor + no-constructor struct + complex flow
// Expect exit code: 0

var g_sum: i64 = 0;

struct Node {
    public id: i64;
}

struct Plain {
    public a: u64;
}

struct ParamLite {
    public a: u64;
    public b: u64;
    public c: u64;
    public d: u64;
}

struct TypeLite {
    public a: u64;
    public b: u64;
    public c: u64;
    public d: u64;
}

impl Node {
    public constructor() {
        self.id = self.id + 10;
    }

    public destructor {
        g_sum = g_sum + self.id;
    }
}

func make_type_from_param(p: ParamLite) -> *TypeLite {
    var t: *TypeLite = new TypeLite{p.a, p.b, p.c, p.d};
    return t;
}

func main(argc, argv) -> i64 {
    // Import

    // Setup
    var p: *Node = new Node{123}();
    var q: *Node = new Node{7}();
    var r: *Plain = new Plain{7};
    var param: ParamLite = ParamLite{1, 2, 3, 4};
    var t_stack: TypeLite = TypeLite{param.a, param.b, param.c, param.d};
    var t_heap: *TypeLite = new TypeLite{param.a + 10, param.b + 20, param.c + 30, param.d + 40};
    var t_from_fn: *TypeLite = make_type_from_param(param);
    var z: *Node = new Node{}();
    var extra_acc: i64 = 0;

    // Execution
    if (p.id != 133) { return 1; }
    if (q.id != 17) { return 2; }
    if (r.a != 7) { return 3; }
    if (t_stack.a != 1) { return 20; }
    if (t_stack.b != 2) { return 21; }
    if (t_stack.c != 3) { return 22; }
    if (t_stack.d != 4) { return 23; }
    if (t_heap.a != 11) { return 24; }
    if (t_heap.b != 22) { return 25; }
    if (t_heap.c != 33) { return 26; }
    if (t_heap.d != 44) { return 27; }
    if (t_from_fn.a != 1) { return 28; }
    if (t_from_fn.b != 2) { return 29; }
    if (t_from_fn.c != 3) { return 30; }
    if (t_from_fn.d != 4) { return 31; }
    if (z.id != 10) { return 32; }

    for (var i: i64 = 0; i < 3; i = i + 1) {
        q.id = q.id + i;
    }

    // Corner: constructor/destructor path through repeated heap allocation.
    for (var k: i64 = 0; k < 4; k = k + 1) {
        var tmp: *Node = new Node{k * 2}();
        extra_acc = extra_acc + tmp.id;
        if ((tmp.id & 1) == 0) {
            extra_acc = extra_acc + 1;
            extra_acc = extra_acc - 1;
        }
        delete tmp;
    }
    if (extra_acc != 52) { return 33; }

    var mix: i64 = p.id + q.id;
    if (mix != 153) { return 4; }
    if (q.id < 20) { return 5; }
    if (q.id > 20) { return 6; }

    delete p;
    delete q;
    delete z;
    delete r;
    delete t_heap;
    delete t_from_fn;

    // Assertion
    if (g_sum != 215) { return 7; }
    return 0;
}
