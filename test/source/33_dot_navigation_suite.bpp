// Covers: dot auto-deref + safe navigation .? semantics (old 33, 34)
// Mode: ssa
// Opt: O0
// Expect exit code: 0

struct PairNav {
    public a: i64;
    public b: i64;
}

impl PairNav {
    public func sum(self: *PairNav) -> i64 {
        return self.a + self.b;
    }
}

struct NodeNav {
    public value: i64;
    public next: *NodeNav;
}

var g_count: i64 = 0;

func inc() -> i64 {
    g_count = g_count + 1;
    return 5;
}

impl NodeNav {
    public func add(self: *NodeNav, x: i64) -> i64 {
        return self.value + x;
    }
}

func main(argc: i64, argv: *u64) -> i64 {
    // old 33 path
    var p: PairNav;
    var pp: *PairNav = &p;

    p.a = 1;
    p.b = 2;
    if (p.a + p.b != 3) { return 1; }

    pp.a = 10;
    pp.b = 20;
    if (pp.a + pp.b != 30) { return 2; }

    var s: i64 = pp.sum();
    if (s != 30) { return 3; }

    // old 34 path
    var n1: NodeNav;
    n1.value = 7;
    n1.next = 0;

    var n0: NodeNav;
    n0.value = 1;
    n0.next = &n1;

    var pn: *NodeNav = &n0;
    var nullp: *NodeNav = 0;

    var v1: i64 = pn.?next.?value;
    if (v1 != 7) { return 101; }

    var v2: i64 = nullp.?next.?value;
    if (v2 != 0) { return 102; }

    var v3: i64 = pn.?next.?next.?value;
    if (v3 != 0) { return 103; }

    g_count = 0;
    var s1: i64 = nullp.?add(inc());
    if (s1 != 0) { return 104; }
    if (g_count != 0) { return 105; }

    var s2: i64 = pn.?add(inc());
    if (s2 != 6) { return 106; }
    if (g_count != 1) { return 107; }

    var s3: i64 = pn.?next.?add(2);
    if (s3 != 9) { return 108; }

    return 0;
}
